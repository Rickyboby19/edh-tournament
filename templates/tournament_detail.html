{% extends "base.html" %}
{% block content %}

<header class="page-header" style="margin-bottom:16px">
  <a class="btn ghost" href="{{ url_for('tournaments_list') }}">&larr; Retour aux tournois</a>
</header>

<section class="grid cols-2" style="align-items:start;gap:16px">

  <!-- Colonne gauche : Infos & actions -->
  <div class="card">
    <h1 style="margin:0 0 8px 0;">{{ t.name }}</h1>
    <p style="margin:0;color:var(--muted)">
      Statut&nbsp;: <strong>{{ t.status }}</strong>
      — Ronde&nbsp;: <strong>{{ t.current_round }}/{{ t.rounds_planned }}</strong>
    </p>

    {% if t.status == "pending" %}
      <p class="hint" style="margin-top:8px">Les inscriptions sont ouvertes tant que le tournoi n’est pas démarré.</p>
    {% elif t.status == "started" %}
      <p class="hint" style="margin-top:8px">Le tournoi est démarré. Les inscriptions sont closes.</p>
    {% else %}
      <p class="hint" style="margin-top:8px">Tournoi terminé.</p>
    {% endif %}

    {% if current_user.is_admin %}
      <hr>
      <h3>Actions admin</h3>

      {% if t.status == "pending" %}
      <form method="post" action="{{ url_for('admin_tournament_start', tournament_id=t.id) }}"
            style="display:flex;gap:12px;align-items:end;flex-wrap:wrap">
        <label>Nombre de rondes prévues
          <input type="number" name="max_rounds" min="1" max="5" value="{{ t.rounds_planned }}">
        </label>
        <button type="submit" class="btn">Démarrer le tournoi</button>
        <span class="hint">Génère les tables pour la ronde 1.</span>
      </form>
      {% elif t.status == "started" %}
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <form method="post" action="{{ url_for('admin_tournament_round_prev', tournament_id=t.id) }}">
          <button class="btn secondary" type="submit">&larr; Ronde précédente</button>
        </form>
        <form method="post" action="{{ url_for('admin_tournament_round_next', tournament_id=t.id) }}">
          <button class="btn" type="submit">Ronde suivante &rarr;</button>
        </form>
      </div>
      {% endif %}

      <p class="hint" style="margin-top:8px">
        Les liens de decklists sont visibles uniquement par les admins.
      </p>
    {% endif %}
  </div>

  <!-- Colonne droite : Inscription / édition -->
  <div class="card">
    <h3>Mon inscription</h3>

    {% set ns = namespace(my_tp=None) %}
    {% for tp, u in registered %}
      {% if u.id == current_user.id %}
        {% set ns.my_tp = tp %}
      {% endif %}
    {% endfor %}

    {% if t.status == "pending" %}
      {% if is_registered_for(t.id, current_user.id) %}
        <p>Vous êtes <strong>inscrit</strong> à ce tournoi. Vous pouvez mettre à jour votre commandant / decklist ou vous désinscrire.</p>

        <form method="post" action="{{ url_for('tournament_register', tournament_id=t.id) }}" id="registerForm"
              style="display:grid;grid-template-columns:1fr;gap:12px">
          <label>Nom du commandant
            <input type="text" name="commander" id="commander" list="cmdr_suggestions"
                   value="{{ ns.my_tp.commander if ns.my_tp else '' }}" placeholder="Ex. Atraxa, Praetors' Voice" required>
            <datalist id="cmdr_suggestions"></datalist>
          </label>

          <div id="commanderPreview" class="commander-preview" style="display:flex;gap:12px;align-items:flex-start"></div>

          <label>Lien de decklist (privé — visible par les admins seulement)
            <input type="url" name="decklist_url"
                   value="{{ ns.my_tp.decklist_url if ns.my_tp else '' }}"
                   placeholder="https://www.moxfield.com/decks/…">
          </label>

          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" type="submit">Mettre à jour</button>
            <form method="post" action="{{ url_for('tournament_unregister', tournament_id=t.id) }}">
              <button class="btn danger" type="submit">Se désinscrire</button>
            </form>
          </div>
        </form>

      {% else %}
        <p>Inscrivez-vous en indiquant votre commandant. Vous pourrez modifier plus tard tant que le tournoi n’est pas démarré.</p>

        <form method="post" action="{{ url_for('tournament_register', tournament_id=t.id) }}" id="registerForm"
              style="display:grid;grid-template-columns:1fr;gap:12px">
          <label>Nom du commandant
            <input type="text" name="commander" id="commander" list="cmdr_suggestions"
                   placeholder="Ex. Atraxa, Praetors' Voice" required>
            <datalist id="cmdr_suggestions"></datalist>
          </label>

          <div id="commanderPreview" class="commander-preview" style="display:flex;gap:12px;align-items:flex-start"></div>

          <label>Lien de decklist (privé — visible par les admins seulement)
            <input type="url" name="decklist_url" placeholder="https://www.moxfield.com/decks/…">
          </label>

          <button class="btn" type="submit">S’inscrire</button>
        </form>
      {% endif %}
    {% else %}
      {% if is_registered_for(t.id, current_user.id) %}
        <p>Vous êtes inscrit à ce tournoi. Les inscriptions sont closes.</p>
      {% else %}
        <p>Les inscriptions sont closes.</p>
      {% endif %}
    {% endif %}
  </div>

  <!-- Colonne entière : Tables de la ronde courante -->
  <div class="card" style="grid-column:1/-1">
    <h3>Tables — Ronde {{ t.current_round }}</h3>
    {% if current_tables %}
      <div class="grid cols-3" style="gap:12px">
        {% for row in current_tables %}
        {% set m = row.match %}
        <div class="subcard">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>Table {{ m.id }}</strong>
            <a class="btn small ghost" href="{{ url_for('match_detail', match_id=m.id) }}">Ouvrir</a>
          </div>
          <ul class="clean-list" style="margin-top:8px">
            {% for p in row.players %}
            <li>{{ p.name }}</li>
            {% endfor %}
          </ul>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <p>Aucune table pour la ronde courante.</p>
    {% endif %}
  </div>

  <!-- Colonne entière : Liste des inscrits -->
  <div class="card" style="grid-column:1/-1">
    <h3>Joueurs inscrits ({{ registered|length }})</h3>
    <ul class="clean-list">
      {% for tp, u in registered %}
      <li style="padding:6px 0;border-bottom:1px solid var(--line)">
        <strong>{{ u.name }}</strong>
        — <em>{{ tp.commander or "Commander non renseigné" }}</em>
        {% if current_user.is_admin and tp.decklist_url %}
          — <a href="{{ tp.decklist_url }}" target="_blank" rel="noopener" class="btn small ghost">Decklist</a>
        {% elif tp.decklist_url %}
          — <span class="muted" title="Réservé aux admins">Decklist (privée)</span>
        {% endif %}
      </li>
      {% else %}
      <li>Aucun joueur inscrit.</li>
      {% endfor %}
    </ul>
  </div>

</section>

<!-- ====== Autocomplete & Preview Commander (Gatherer image) ====== -->
<script>
(function() {
  const input = document.querySelector('#commander');
  if (!input) return;

  const datalist = document.querySelector('#cmdr_suggestions');
  const preview = document.querySelector('#commanderPreview');

  let lastQ = '';
  let inFlight = 0;
  const debounce = (fn, ms=250) => {
    let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
  };

  async function fetchJSON(url) {
    const r = await fetch(url, { headers: { 'Accept': 'application/json' }});
    if (!r.ok) throw new Error('HTTP ' + r.status);
    return r.json();
  }

  function renderPreview(card, exactName) {
    preview.innerHTML = '';
    if (!card) return;

    // Essaye d’obtenir un multiverse id pour afficher l’image & lien Gatherer
    let multiverseId = null;
    if (card.multiverse_ids && card.multiverse_ids.length) {
      multiverseId = card.multiverse_ids[0];
    } else if (card.card_faces && card.card_faces.length && card.card_faces[0].multiverse_id) {
      multiverseId = card.card_faces[0].multiverse_id;
    }

    let imgSrc = null;
    if (multiverseId) {
      imgSrc = `https://gatherer.wizards.com/Handlers/Image.ashx?multiverseid=${multiverseId}&type=card`;
    } else if (card.image_uris && card.image_uris.normal) {
      // Fallback Scryfall si pas d’ID Gatherer
      imgSrc = card.image_uris.normal;
    } else if (card.card_faces && card.card_faces[0].image_uris && card.card_faces[0].image_uris.normal) {
      imgSrc = card.card_faces[0].image_uris.normal;
    }

    const box = document.createElement('div');
    box.style.display = 'flex';
    box.style.gap = '12px';
    box.style.alignItems = 'flex-start';

    if (imgSrc) {
      const img = document.createElement('img');
      img.src = imgSrc;
      img.alt = exactName || card.name;
      img.style.maxWidth = '200px';
      img.style.borderRadius = '8px';
      img.style.boxShadow = '0 2px 8px rgba(0,0,0,.15)';
      box.appendChild(img);
    }

    const meta = document.createElement('div');
    const title = document.createElement('div');
    title.innerHTML = `<strong>${exactName || card.name}</strong>`;
    meta.appendChild(title);

    if (multiverseId) {
      const a = document.createElement('a');
      a.href = `https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=${multiverseId}`;
      a.target = '_blank';
      a.rel = 'noopener';
      a.className = 'btn small ghost';
      a.textContent = 'Voir sur Gatherer';
      a.style.marginTop = '6px';
      meta.appendChild(a);
    }

    box.appendChild(meta);
    preview.appendChild(box);
  }

  async function loadSuggestions(q) {
    if (!q || q.length < 3) { datalist.innerHTML = ''; return; }
    lastQ = q; inFlight++;
    try {
      // Autocomplete Scryfall
      const data = await fetchJSON(`https://api.scryfall.com/cards/autocomplete?q=${encodeURIComponent(q)}`);
      if (q !== lastQ) return;
      datalist.innerHTML = '';
      (data.data || []).slice(0, 20).forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        datalist.appendChild(opt);
      });
    } catch(e) {
      // ignore
    } finally {
      inFlight--;
    }
  }

  const debouncedSuggest = debounce(loadSuggestions, 250);

  async function updatePreviewFor(name) {
    if (!name) { preview.innerHTML = ''; return; }
    try {
      // Récup carte exacte (pour multiverse_id)
      const card = await fetchJSON(`https://api.scryfall.com/cards/named?exact=${encodeURIComponent(name)}`);
      renderPreview(card, name);
    } catch(e) {
      preview.innerHTML = '';
    }
  }

  input.addEventListener('input', (ev) => {
    debouncedSuggest(ev.target.value.trim());
  });

  input.addEventListener('change', (ev) => {
    updatePreviewFor(ev.target.value.trim());
  });

  // Si un nom est déjà présent (édition), tente un preview au chargement
  if (input.value && input.value.trim().length >= 1) {
    updatePreviewFor(input.value.trim());
  }
})();
</script>

{% endblock %}
