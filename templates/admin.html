{% extends "base.html" %}
{% block title %}Administration â€” Tournoi{% endblock %}
{% block content %}

<h2>Administration du tournoi</h2>

<p style="margin: 6px 0 12px">
  <a class="btn ghost" href="{{ url_for('admin_submissions') }}">Voir toutes les soumissions de points</a>
</p>


<section class="grid cols-3">

  <!-- Statistiques -->
  <div class="card">
    <h3>Statistiques</h3>
    <ul style="margin:8px 0 0 0; padding-left:18px;">
      <li>Joueurs : <strong>{{ total_users }}</strong></li>
      <li>Tables (matches) : <strong>{{ total_matches }}</strong></li>
      <li>Soumissions : <strong>{{ total_submissions }}</strong></li>
      <li>Rondes existantes : {% if rounds %}{{ rounds|join(', ') }}{% else %}â€”{% endif %}</li>
    </ul>
  </div>

  <!-- Mise Ã  jour des points -->
  <div class="card">
    <h3>Mise Ã  jour des points</h3>
    <form method="post" action="{{ url_for('admin_points_update') }}">
      <label>Joueur
        <select name="user_id">
          {% for p in players %}
            <option value="{{ p.id }}">{{ p.name }} â€” {{ p.commander }} ({{ p.email }})</option>
          {% endfor %}
        </select>
      </label>
      <label>Mode
        <select name="mode">
          <option value="delta">Ajouter/Retirer (Î”)</option>
          <option value="set">Remplacer (=)</option>
        </select>
      </label>
      <label>Valeur
        <input type="number" name="value" value="1" />
      </label>
      <button type="submit" class="btn">Mettre Ã  jour</button>
    </form>
  </div>

  <!-- Reset tournoi -->
  <div class="card">
    <h3>RÃ©initialiser le tournoi</h3>
    <form method="post" action="{{ url_for('admin_reset') }}">
      <label>Ã‰tendue du reset
        <select name="scope">
          <option value="scores">Scores seulement (Leaderboard)</option>
          <option value="matches">Matches + soumissions</option>
          <option value="all">Tout (matches, soumissions, scores)</option>
        </select>
      </label>
      <label class="checkbox">
        <input type="checkbox" name="keep_players" checked>
        Conserver les joueurs
      </label>
      <button type="submit" class="btn" onclick="return confirm('Confirmer la rÃ©initialisation ?')">RÃ©initialiser</button>
    </form>
    <p class="hint" style="margin-top:8px">
      Supprime dâ€™abord approbations/soumissions, puis liaison joueurs et matches.  
      En mode â€œToutâ€, supprime aussi le Leaderboard.  
      Option : conserver les joueurs.
    </p>
  </div>

  <!-- GÃ©nÃ©rer des tables (rondes) -->
  <div class="card" style="grid-column:1 / -1">
    <h3>GÃ©nÃ©rer des tables par ronde</h3>
    <form method="post" action="{{ url_for('admin_new_round') }}" style="display:flex; gap:10px; align-items:flex-end;">
      <label>Ronde #
        <input type="number" name="round_number" value="1" min="1" />
      </label>
      <button type="submit" class="btn">CrÃ©er/Remplacer les tables</button>
    </form>
    <p class="hint" style="margin-top:8px">CrÃ©e des pods de 4 joueurs selon lâ€™ordre dâ€™inscription.</p>
  </div>

  <!-- Leaderboard aperÃ§u -->
  <div class="card" style="grid-column:1 / -1">
    <h3>Leaderboard (aperÃ§u)</h3>
    <table class="table">
      <thead><tr><th>#</th><th>Joueur</th><th>Points</th></tr></thead>
      <tbody>
        {% for row, user in leaderboard %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ user.name }} â€” <span class="hint">{{ user.commander }}</span></td>
            <td><strong>{{ row.points }}</strong></td>
          </tr>
        {% else %}
          <tr><td colspan="3">Aucun score enregistrÃ©.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Envoi de courriels -->
  <div class="card" style="grid-column:1 / -1">
    <h3>Envoyer un courriel</h3>
    <form method="post" action="{{ url_for('admin_email') }}">
      <div class="grid cols-3">
        <div>
          <label>Destinataires</label>
          <label class="checkbox"><input type="radio" name="recipients_mode" value="selected" checked> SÃ©lectionnÃ©s</label>
          <label class="checkbox"><input type="radio" name="recipients_mode" value="all"> Tous les joueurs</label>

          <div id="recipientsSelect" style="margin-top:8px">
            <select name="player_ids" multiple size="8" style="width:100%">
              {% for p in players %}
                <option value="{{ p.id }}">{{ p.name }} â€” {{ p.email }}</option>
              {% endfor %}
            </select>
            <div class="hint">Maintiens Ctrl (ou Cmd) pour multisÃ©lection.</div>
          </div>
        </div>

        <div>
          <label>Sujet
            <input type="text" name="subject" placeholder="Sujet du message" required>
          </label>
          <label>Message
            <textarea name="body" rows="7" placeholder="Ton message iciâ€¦" style="width:100%"></textarea>
          </label>
        </div>

        <div style="display:flex;align-items:end;">
          <button type="submit" class="btn">Envoyer</button>
        </div>
      </div>
    </form>
  </div>

</section>

<!-- DÃ‰BUT DU TOURNOI + PHASES FINALES -->
<div class="card" style="grid-column:1 / -1">
  <h3>Phases du tournoi</h3>

  <form method="post" action="{{ url_for('admin_tournament_start') }}" style="display:flex; gap:10px; align-items:flex-end; margin-bottom:10px;">
    <label>Nombre de rondes (max 5)
      <input type="number" name="max_rounds" value="5" min="1" max="5" />
    </label>
    <button type="submit" class="btn">ğŸ”” DÃ©but du tournoi</button>
  </form>

  <form method="post" action="{{ url_for('admin_tournament_semis') }}" style="display:flex; gap:10px; align-items:flex-end; margin-bottom:10px;">
    <button type="submit" class="btn">ğŸ GÃ©nÃ©rer les demi-finales (Top 8)</button>
  </form>

  <form method="post" action="{{ url_for('admin_tournament_final') }}" style="display:flex; gap:10px; align-items:flex-end;">
    <button type="submit" class="btn">ğŸ‘‘ GÃ©nÃ©rer la finale (Top 4)</button>
  </form>

  <p class="hint" style="margin-top:8px">
    Les rondes de saison utilisent une heuristique qui <em>maximise les rencontres uniques</em>.<br>
    ThÃ©oriquement, en 5 rondes, chaque joueur peut rencontrer au plus 15 adversaires uniques (3 par ronde).
  </p>
</div>


<script>
  // Masque/affiche la sÃ©lection multiple selon le mode
  const radios = document.querySelectorAll('input[name="recipients_mode"]');
  const selBox = document.getElementById('recipientsSelect');
  function toggleRecipients(){
    selBox.style.display = (document.querySelector('input[name="recipients_mode"]:checked').value === 'selected') ? '' : 'none';
  }
  radios.forEach(r => r.addEventListener('change', toggleRecipients));
  toggleRecipients();
</script>

{% endblock %}
