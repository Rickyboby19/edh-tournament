{% extends "base.html" %}
{% block content %}
<h1>Administration</h1>

<section class="stack">
  <div class="card">
    <h2>Raccourcis</h2>
    <div class="btn-row">
      <a class="btn" href="{{ url_for('submissions_pending') }}">Confirmations en attente</a>
      <a class="btn" href="{{ url_for('admin_submissions') }}">Toutes les soumissions</a>
      <a class="btn" href="{{ url_for('admin_users') }}">Gérer les utilisateurs</a>
      <a class="btn" href="{{ url_for('players') }}">Liste des joueurs</a>
    </div>
  </div>

  <div class="grid cols-3">
    <div class="card">
      <h3>Statistiques</h3>
      <ul style="margin:8px 0 0 16px">
        <li>Utilisateurs: <strong>{{ total_users }}</strong></li>
        <li>Matches: <strong>{{ total_matches }}</strong></li>
        <li>Soumissions: <strong>{{ total_submissions }}</strong></li>
        <li>Rondes existantes: {{ rounds|join(', ') if rounds else '—' }}</li>
      </ul>
    </div>

    <div class="card">
      <h3>Créer un tournoi</h3>
      <form method="post" action="{{ url_for('admin_tournament_create') }}" class="stack">
        <label>
          Nom
          <input type="text" name="name" placeholder="Tournoi EDH" required>
        </label>
        <label>
          Rondes prévues (1–5)
          <input type="number" name="rounds_planned" min="1" max="5" value="5" required>
        </label>
        <button class="btn" type="submit">Créer</button>
        <span class="hint">Le tournoi démarre avec le statut <em>pending</em>.</span>
      </form>
    </div>

    <div class="card">
      <h3>Maintenance / Reset</h3>
      <form method="post" action="{{ url_for('admin_reset') }}" class="stack">
        <label>
          Portée
          <select name="scope">
            <option value="scores">Scores (Leaderboard)</option>
            <option value="matches">Matches + Soumissions</option>
            <option value="all">Tout (réinit. complète)</option>
          </select>
        </label>
        <label style="display:flex;gap:8px;align-items:center">
          <input type="checkbox" name="keep_players">
          Conserver les utilisateurs
        </label>
        <button class="btn danger" type="submit" onclick="return confirm('Confirmer la réinitialisation ?')">Réinitialiser</button>
      </form>
    </div>
  </div>

  <div class="card" style="grid-column:1/-1">
    <h2>Tournois</h2>
    {% if tournaments %}
    <div class="stack">
      {% for t in tournaments %}
      <div class="softrow" style="justify-content:space-between;align-items:center;border-top:1px solid var(--line);padding:12px 0;">
        <div>
          <div style="font-weight:600;font-size:18px;margin-bottom:4px">{{ t.name }}</div>
          <div class="muted">
            Statut: <strong>{{ t.status }}</strong>
            &nbsp;•&nbsp; Ronde: <strong>{{ t.current_round }}/{{ t.rounds_planned }}</strong>
            &nbsp;•&nbsp; Créé: {{ t.created_at.strftime('%Y-%m-%d %H:%M') if t.created_at }}
            {% if t.started_at %}&nbsp;•&nbsp; Démarré: {{ t.started_at.strftime('%Y-%m-%d %H:%M') }}{% endif %}
            {% if t.finished_at %}&nbsp;•&nbsp; Terminé: {{ t.finished_at.strftime('%Y-%m-%d %H:%M') }}{% endif %}
          </div>
        </div>

        <div class="btn-row">
          <!-- Lien Gérer => page publique de détail -->
          <a class="btn" href="{{ url_for('tournament_detail', tournament_id=t.id) }}">Gérer</a>

          {% if t.status == 'pending' %}
            <form method="post" action="{{ url_for('admin_tournament_start', tournament_id=t.id) }}">
              <label class="sr-only">Rondes prévues</label>
              <input type="number" name="max_rounds" min="1" max="5" value="{{ t.rounds_planned }}" style="width:84px">
              <button class="btn" type="submit">Démarrer</button>
            </form>

            <form method="post" action="{{ url_for('admin_tournament_cancel', tournament_id=t.id) }}" onsubmit="return confirm('Annuler ce tournoi ?')">
              <button class="btn danger" type="submit">Annuler</button>
            </form>
          {% elif t.status == 'started' %}
            <form method="post" action="{{ url_for('admin_tournament_round_prev', tournament_id=t.id) }}">
              <button class="btn secondary" type="submit">← Ronde précédente</button>
            </form>
            <form method="post" action="{{ url_for('admin_tournament_round_next', tournament_id=t.id) }}">
              <button class="btn" type="submit">Ronde suivante →</button>
            </form>
            <form method="post" action="{{ url_for('admin_tournament_cancel', tournament_id=t.id) }}" onsubmit="return confirm('Annuler ce tournoi ? Toutes les données associées seront nettoyées.')">
              <button class="btn danger" type="submit">Annuler</button>
            </form>
          {% else %}
            <span class="badge">{{ t.status|capitalize }}</span>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
      <p>Aucun tournoi.</p>
    {% endif %}
  </div>
</section>
{% endblock %}
